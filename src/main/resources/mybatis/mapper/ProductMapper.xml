<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.fiveminutesmarket.product.repository.ProductRepository">

    <resultMap id="productListDTO" type="kr.fiveminutesmarket.product.dto.ProductListDto">
        <id property="productId" column="product_id" />
        <result property="sellerId" column="seller_id" />
        <result property="quantity" column="quantity" />
        <result property="name" column="name" />
        <result property="price" column="price" />
        <result property="thumb" column="thumb" />
        <result property="detail" column="detail" />
        <association property="mainCategory" javaType="kr.fiveminutesmarket.category.domain.MainCategory">
            <id property="mainCategoryId" column="main_category_id" />
            <result property="mainCategoryName" column="main_category_name" />
        </association>
        <association property="subCategory" javaType="kr.fiveminutesmarket.category.domain.SubCategory">
            <id property="subCategoryId" column="sub_category_id" />
            <result property="subCategoryName" column="sub_category_name" />
        </association>
        <collection property="options" ofType="kr.fiveminutesmarket.option.dto.OptionDto">
            <id property="optionId" column="option_id" />
            <result property="isOptional" column="is_optional" />
            <collection property="optionItemList" ofType="kr.fiveminutesmarket.option.dto.OptionItemDto">
                <id property="optionItemId" column="option_item_id" />
                <result property="optionItemName" column="option_item_name" />
                <result property="optionItemPrice" column="option_item_price" />
            </collection>
        </collection>
    </resultMap>

    <select id="findAll" resultMap="productListDTO" parameterType="map">
        SELECT *
        FROM product
        LEFT OUTER JOIN main_category ON product.main_category_id = main_category.main_category_id
        LEFT OUTER JOIN sub_category ON product.sub_category_id = sub_category.sub_category_id
        LEFT OUTER JOIN `option` ON product.product_id = `option`.product_id
        LEFT OUTER JOIN option_item ON `option`.option_id = option_item.option_id
        LIMIT #{startIndex}, #{itemCount}
    </select>

    <select id="findByProductId" resultType="kr.fiveminutesmarket.product.domain.Product">
        SELECT *
        FROM product
        WHERE product_id = #{productId}
    </select>

    <insert id="insertProduct" parameterType="kr.fiveminutesmarket.product.domain.Product">
        INSERT INTO product (main_category_id, sub_category_id, name, price, thumb, detail)
        VALUES (#{mainCategoryId}, #{subCategoryId}, #{name}, #{price}, #{thumb}, #{detail})
        <selectKey keyProperty="productId" resultType="java.lang.Long" order="AFTER">
            SELECT LAST_INSERT_ID() as product_id
        </selectKey>
    </insert>

</mapper>